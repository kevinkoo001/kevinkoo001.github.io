<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>ELF Sections for Exception Handling | Hyungjoon (Kevin) Koo</title> <meta name="author" content="Hyungjoon Koo"> <meta name="description" content=""> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://kevinkoo001.github.io/blog/2017/elf-sections-for-exception-handling/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Hyungjoon (Kevin) Koo</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">ELF Sections for Exception Handling</h1> <p class="post-meta">September 5, 2017• kevinkoo001@gmail.com</p> <p class="post-tags"> <a href="/blog/2017"> <i class="fas fa-calendar fa-sm"></i> 2017 </a>   ·   <a href="/blog/category/miscellaneous-stuff"> <i class="fas fa-tag fa-sm"></i> Miscellaneous Stuff</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>In ELF binary, there are two sections to support exception handling routines that are predominately used by C++ applications: <em>.eh_frame</em> and <em> .eh_frame_hdr</em>. However, <a href="https://software.intel.com/sites/default/files/article/402129/mpx-linux64-abi.pdf" rel="external nofollow noopener" target="_blank">System V Application Binary Interface (ABI) for AMD64</a> mandates to have those sections even they are written in C.</p> <p><strong>a) .<em>eh_frame</em> section</strong></p> <p>The .<em>eh_frame</em> section has the same structure with <em>.debug_frame</em>, which follows <a href="http://www.dwarfstd.org/doc/DWARF4.pdf" rel="external nofollow noopener" target="_blank">DWARF</a> format. It represents the table that describes how to set registers to restore the previous call frame at runtime. DWARF designers allow for having flexible mechanism to be able to unwind the stack with various expressions including constant values, arithmetic, memory dereference, register contents, and control flow.</p> <p>The <em>.eh_frame</em> section contains at least one or more Call Frame Information (CFI) records. Each CFI consists of two entry forms: Common Information Entry (CIE) and Frame Description Entry (FDE). Every CFI has a single CIE and one or more FDEs. CFI usually corresponds to a single object file. Likewise, so does FDE to a single function. However, there might be multiple CIEs and FDEs corresponding to the parts of a function when the function has a non-contiguous range in a virtual memory space. The following shows the fields of each entry in detail.</p> <table width="553"><tbody> <tr> <td width="183">**CIE Fields** </td> <td width="157">**Data Format** </td> <td width="213">**Description** </td> </tr> <tr> <td>length  </td> <td>4 bytes </td> <td>Total length of the CIE except this field </td> </tr> <tr> <td>CIE_id  </td> <td>4 or 8 bytes </td> <td>0 for .eh_frame </td> </tr> <tr> <td>Version  </td> <td>1 byte </td> <td>Value 1 </td> </tr> <tr> <td>Augmentation  </td> <td>A null-terminated UTF-8 string </td> <td>0 if no augmetation </td> </tr> <tr> <td>Code alignment factor  </td> <td>unsigned LEB128 </td> <td>Usually 1 </td> </tr> <tr> <td>Data alignment factor  </td> <td>signed LEB128 </td> <td>Usually -4 (encoded as 0x7C) </td> </tr> <tr> <td>return_address_register  </td> <td>unsigned LEB128 </td> <td>Dwarf number of the return register </td> </tr> <tr> <td>Augmentation data length  </td> <td>unsigned LEB128 </td> <td>Present if Augmentation has 'z' </td> </tr> <tr> <td>Initial instructions </td> <td>array of bytes </td> <td>Dwarf Call Frame Instructions </td> </tr> <tr> <td>padding </td> <td>array of bytes </td> <td>DW_CFA_nop instructions to match the length </td> </tr> </tbody></table> <table width="553"><tbody> <tr> <td width="183">**FDE Fields** </td> <td width="157">**Data Format** </td> <td width="213">**Description** </td> </tr> <tr> <td>Length  </td> <td>4 bytes </td> <td>Total length of the FDE except this field; 0 means end of all records </td> </tr> <tr> <td>CIE pointer  </td> <td>4 or 8 bytes </td> <td>Distance to the nearest preceding (parent) CIE </td> </tr> <tr> <td>Initial location  </td> <td>various bytes </td> <td>Reference to the function corresponding to the FDE </td> </tr> <tr> <td>Range length  </td> <td>various bytes </td> <td>Size of the function corresponding to the FDE </td> </tr> <tr> <td>Augmentation data length  </td> <td>unsigned LEB128 </td> <td>Present if CIE Augmentation is non-empty </td> </tr> <tr> <td>Instructions </td> <td>array of bytes </td> <td>Dwarf Call Frame Instructions </td> </tr> </tbody></table> <p>Here is an example of parsing a CIE and FDE (with a nice <a href="http://www.hexblog.com/wp-content/uploads/2012/06/recon-2012-skochinsky-scripts.zip" rel="external nofollow noopener" target="_blank">Skochinsky’s script</a> for IDA Pro). The sizes of the following CIE and FDE are 0x14 and 0x34 respectively. The FDE has a CIE pointer pointing to the parent CIE (at 0x4090A0). The function location corresponding to this FDE starts from 0x400c70 to 0x4010c0, whose size is 0x450.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CIE (Common Information Entry)
.eh_frame:0x04090A0 14 00 00 00     ; Size
.eh_frame:0x04090A4 00 00 00 00     ; CIE id
.eh_frame:0x04090A8 01              ; Version
.eh_frame:0x04090A9 7A 52 00        ; Augmentation String (aZr)
.eh_frame:0x04090AC 01              ; Code alignment factor
.eh_frame:0x04090AD 78              ; Data alignment factor
.eh_frame:0x04090AE 10              ; Return register
.eh_frame:0x04090AF 01              ; Augmentation data length
.eh_frame:0x04090B0 1B              ; R: FDE pointers encoding
.eh_frame:0x04090B1 0C 07 08 90+    ; Initial CFE Instructions

FDE (Frame Descriptor Entry)
.eh_frame:0x04090B8 34 00 00 00     ; Size
.eh_frame:0x04090BC 1C 00 00 00     ; CIE pointer (0x4090A0)
.eh_frame:0x04090C0 B0 7B FF FF     ; Initial location=0x400C70
.eh_frame:0x04090C4 50 04 00 00     ; Range length=0x450(end=0x4010C0)
.eh_frame:0x04090C8 00              ; Augmentation data length
.eh_frame:0x04090C9 41 0E 10 42+    ; CFE Instructions
...
</code></pre></div></div> <p><strong>b) .<em>eh_frame_hdr</em> section</strong></p> <p>The .<em>eh_frame_hdr</em> section contains a series of attributes, followed by the table of multiple pairs of (initial location, pointer to the FDE in the .<em>eh_frame</em>). The entries are sorted by functions that allows to perform a quick binary search of O(log n). </p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version (uint8)            structure version (=1)
eh_frame_ptr_enc (uint8)   encoding of eh_frame_ptr
fde_count_enc (uint8)      encoding of fde_count
table_enc (uint8)          encoding of table entries
eh_frame_ptr (enc)         pointer to the start of the .eh_frame section
fde_count (enc)            number of entries in the table
----------------------- Table starts from here -------------------------
initial_loc[i]             initial location for the FDE
fde_ptr[i]                 corresponding FDE
------------------------------------------------------------------------
</code></pre></div></div> <p>The next figure is a brief illustration of the relationship of two sections.</p> <p><a href="http://dandylife.net/blog/archives/686/eh_frame" rel="external nofollow noopener" target="_blank"><img src="http://dandylife.net/blog/wp-content/uploads/2017/09/eh_frame.jpg" alt=""></a></p> <p>Note that the attribute, <em>table_enc</em>, describes how the table has been encoded. It consists of lower 4 bits for value and upper 4 bits for encoding as follows: DWARF Exception Header value format (lower 4 bits) and DWARF Exception Header Encoding (upper 4 bits)</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DW_EH_PE_omit	 0xff	No value is present
DW_EH_PE_uleb128 0x01	Unsigned value is encoded using LEB128
DW_EH_PE_udata2	 0x02	A 2 bytes unsigned value
DW_EH_PE_udata4	 0x03	A 4 bytes unsigned value
DW_EH_PE_udata8	 0x04	An 8 bytes unsigned value
DW_EH_PE_sleb128 0x09	Signed value is encoded using LEB128
DW_EH_PE_sdata2	 0x0A	A 2 bytes signed value
DW_EH_PE_sdata4	 0x0B	A 4 bytes signed value
DW_EH_PE_sdata8	 0x0C	An 8 bytes signed value

DW_EH_PE_absptr  0x00 Used with no modification 
DW_EH_PE_pcrel   0x10 Relative to the current program counter 
DW_EH_PE_datarel 0x30 Relative to the beginning of the .eh_frame_hdr 
DW_EH_PE_omit    0xff No value is present
</code></pre></div></div> <p><strong>References</strong><a href="https://refspecs.linuxfoundation.org/LSB_1.3.0/gLSB/gLSB/ehframehdr.html" rel="external nofollow noopener" target="_blank"><br> https://refspecs.linuxfoundation.org/LSB_1.3.0/gLSB/gLSB/ehframehdr.htm<br> </a><a href="http://www.dwarfstd.org/doc/DWARF4.pdf" rel="external nofollow noopener" target="_blank">http://www.dwarfstd.org/doc/DWARF4.pdf<br> </a><a href="http://www.hexblog.com/wp-content/uploads/2012/06/Recon-2012-Skochinsky-Compiler-Internals.pdf" rel="external nofollow noopener" target="_blank">http://www.hexblog.com/wp-content/uploads/2012/06/Recon-2012-Skochinsky-Compiler-Internals.pdf<br> </a><a href="https://software.intel.com/sites/default/files/article/402129/mpx-linux64-abi.pdf" rel="external nofollow noopener" target="_blank">https://software.intel.com/sites/default/files/article/402129/mpx-linux64-abi.pdf<br> </a></p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2018/compiler-assisted-code-randomization/">Compiler-assisted Code Randomization</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2016/code-reuse-attacks-and-defenses/">Code Reuse Attacks and Defenses</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2016/dynamic-linking-in-elf/">Dynamic Linking in ELF</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2016/juggling-the-gadgets-instruction-displacement-to-mitigate-code-reuse-attack/">Juggling the Gadgets: Instruction Displacement to Mitigate Code Reuse Attack</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2016/cyber-grand-challenge-by-darpa/">Cyber Grand Challenge by DARPA</a> </li> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 Hyungjoon Koo. Last updated: August 29, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>