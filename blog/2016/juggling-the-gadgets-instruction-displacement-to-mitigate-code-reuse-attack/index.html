<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Juggling the Gadgets: Instruction Displacement to Mitigate Code Reuse Attack | Hyungjoon (Kevin) Koo</title> <meta name="author" content="Hyungjoon Koo"> <meta name="description" content=""> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://kevinkoo001.github.io/blog/2016/juggling-the-gadgets-instruction-displacement-to-mitigate-code-reuse-attack/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Hyungjoon (Kevin) Koo</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Juggling the Gadgets: Instruction Displacement to Mitigate Code Reuse Attack</h1> <p class="post-meta">May 31, 2016• kevinkoo001@gmail.com</p> <p class="post-tags"> <a href="/blog/2016"> <i class="fas fa-calendar fa-sm"></i> 2016 </a>   ·   <a href="/blog/tag/gadget"> <i class="fas fa-hashtag fa-sm"></i> gadget</a>   <a href="/blog/tag/return-oriented-programming"> <i class="fas fa-hashtag fa-sm"></i> return oriented programming</a>   <a href="/blog/tag/rop"> <i class="fas fa-hashtag fa-sm"></i> rop</a>     ·   <a href="/blog/category/attack-amp-defense-cyber-warfare"> <i class="fas fa-tag fa-sm"></i> Attack &amp; Defense, Cyber Warfare</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p><strong>I. Background</strong></p> <p>As modern OS has banned running arbitrary <strong>code by injection</strong> (i.e., a page in a virtual memory space cannot be set both executable and writable permission at the same time by default), <strong>code reuse</strong> attack has gained its popularity by taking advantage of the existing permission such as [return/jump/call]-oriented programming. (i.e., ROP attack)</p> <p>The essence of the attack is that an adversary has the power of <strong>predicting address space</strong> and <strong>diverting control flow.</strong> Hence, two main approaches to defend against code reuse are either to break the knowledge of code layout with <strong>randomization</strong> or to restrict the use of the branches with <strong>control flow integrity</strong>.</p> <p><strong>II. Overview of Instruction Displacement and Gadgets</strong></p> <p>This work focuses on the former perspective, code diversification in particular. <a href="http://dandylife.net/blog/archives/477" rel="external nofollow noopener" target="_blank">One of previous works </a>introduces an In-Place Randomization (IPR) including instruction substitution, instruction reordering and/or register reassignment. The advantage of IPR is that it could be applied to stripped binaries thus practical for real applications with (theoretically) no overhead. It assumed both incomplete control flow graph and inaccurate disassembly from a binary that has been stripped off additional information - debugging symbols and source code - during compilation. However, it ended up with remaining gadgets (20%) that might be enough for the construction of a functional ROP payload.</p> <p>The idea is to break more gadgets by <strong>instruction displacement</strong>. The goal of this technique is to maximize the gadget coverage. It might be thought of another way on top of IPR. However, displacement does not necessarily combine with it. Instruction displacement can be tied to any diversification technique with incomplete gadget coverage in order to increase it.</p> <p>The following figure illustrates an example of what gadgets look like. (Here they are defined by looking ahead up to 5 instructions long from a ‘<em>ret</em>’ instruction for the purpose of comparison with previous work.) </p> <p><a href="http://dandylife.net/blog/archives/606/intended_vs_unintended" rel="external nofollow noopener" target="_blank"><img src="http://dandylife.net/blog/wp-content/uploads/2016/05/intended_vs_unintended.png" alt="intended_vs_unintended"></a></p> <p>The dotted box represents pre-discovered gadgets. Assume that the process of gadget discovery is known thus we have the same power of obtaining gadgets with an adversary. The bold letters mean the first byte of each instruction. There are six different gadgets varying from 2 to 10 bytes in size. G1, G5, and G6 are <strong>intended gadgets</strong> because the starting byte of the first instruction is the same with the intended instructions; whereas, G2, G3, and G4 are <strong>unintended gadgets</strong> because the starting byte of the first instruction is different from the intended instructions. This shows that a lot of gadgets are <strong>nested</strong> in nature.</p> <p><strong>III. High Level View</strong></p> <p>A high level view of gadget displacement can be seen as following.</p> <p><a href="http://dandylife.net/blog/archives/606/high_view" rel="external nofollow noopener" target="_blank"><img src="http://dandylife.net/blog/wp-content/uploads/2016/05/high_view.png" alt="high_view"></a></p> <p>First, we obtain pre-computed gadgets and displace them to a new section, named .<em>ropf</em>. (which has meant _rop-proof _area) Note that the unit of displacement should be within a basic block to maintain the semantic of the original program, which is the most important requirement.</p> <p>In order to displace gadgets, intuitively a <em>jmp</em> instruction is required that takes 5 bytes space; 1 byte for mnemonic and 4 bytes for a relative address. In other words, 5-byte-space in a single basic block is necessary for displacement. The remaining area is filled with <em>0xCC</em> or INT 3 (interrupt 3). The INT <strong>3</strong> instruction is used by debuggers to temporarily replace an instruction to set a break point. Therefore any attempt to access to it would interrupt a program.</p> <p>Another consideration is when the displaced area contains any branches and calls with relative addresses. All code references should be re-computed properly. Likewise, when the displaced area includes any absolute address in a relocation table (i.e., .<em>reloc</em> section in a PE file), it has to be updated accordingly as well.</p> <p><strong>IV. Displacement Strategy</strong></p> <p>To achieve both efficiency and effectiveness for binary instrumentation, we set up the strategy like followings:</p> <ul> <li>First, in general, jumping back and forth between two sections (.<em>text</em> and .<em>ropf</em>) is required. However, it is not necessary if the displaced region ends with either unconditional jump or return instruction because they know where to go back. For example, a <em>ret</em> instruction would take whatever value on the stack to return.</li> <li>It would be better to keep the number of displaced regions low for performance degradation. This can be resolved by choosing the largest gadget to include all nested gadgets within a basic block. It helps to break the gadgets whose sizes are less than 5 bytes.</li> <li>For intended gadgets, it is simple enough to find the starting byte of the first intended instruction of the gadget and displace it into a .<em>ropf</em>.</li> <li>For unintended gadgets, find the instruction all the way back in the same basic block for displacement. Otherwise, an attacker could also follow the inserted jump to make use of the existing gadgets.  </li> <li>Finally, we shuffle the displaced instructions around in a .<em>ropf</em> to avoid generating the same binary.</li> </ul> <p>Putting all things together, the following algorithm summarizes the above. Per each gadget, it decides whether or not the gadget can be broken when IPR is not available.</p> <p><a href="http://dandylife.net/blog/archives/606/disp_algo" rel="external nofollow noopener" target="_blank"><img src="http://dandylife.net/blog/wp-content/uploads/2016/05/disp_algo.png" alt="disp_algo"></a></p> <p><strong>V. Binary Instrumentation</strong></p> <p>In this work, PE (portable executable),  a standard format in Windows, has been targeted in x86 machine. (You may find <a href="http://dandylife.net/blog/archives/388" rel="external nofollow noopener" target="_blank">here</a> useful for more about PE) Briefly, PE consists of several section headers and corresponding data.</p> <p><a href="http://dandylife.net/blog/archives/606/binary" rel="external nofollow noopener" target="_blank"><img src="http://dandylife.net/blog/wp-content/uploads/2016/05/binary.png" alt="binary"></a></p> <p>Above all, a new .ropf section header is appended at the end of existing section headers and a .ropf section that displaced code snippets reside in at the end of the binary. Next, all relocation entries are rebuilt in a relocation section. And some optional header fields including size of code and checksum should be adjusted accordingly. Other than those, all other area has to be preserved as they are. Displacing other sections may increase a complexity a lot during binary instrumentation.</p> <p><a href="http://dandylife.net/blog/archives/606/reloc_table" rel="external nofollow noopener" target="_blank"><img src="http://dandylife.net/blog/wp-content/uploads/2016/05/reloc_table.png" alt="reloc_table"></a></p> <p>For a relocation table, it should be entirely reconstructed rather than appending new entries. This is because if original entries would be left, the inserted jump instruction can be overwritten during loading a binary into memory. A relocation table in a PE file consists of multiple relocation blocks. Each block starts with relative virtual address (RVA), block size and a series of entries of 2-byte value each. The first 4 bits represent type, and the last 12 bits represent offset.</p> <p>For the example of the entry 0x304C in the figure above, 0x3000 means a relocation entry type and 0x4C is an offset from a RVA of the block, which means the absolute address in a virtual address 0x1C04C has to updated appropriately when loaded. Note that total number of all entries should be identical at all times.</p> <p><strong>VI. Evaluation</strong></p> <p>From almost 2,700 samples from Windows 7, 8.1 and benign applications, more than 13 million gadgets has been found in total. 6.37% gadgets are located in the unreachable regions (in reds below) mostly because of the failure of drawing control flow graph. The following plot illustrates an interesting the distribution of gadget kinds (small ones, unintended ones, and call-preceded ones) and that of broken gadgets. </p> <p><a href="http://dandylife.net/blog/archives/606/result" rel="external nofollow noopener" target="_blank"><img src="http://dandylife.net/blog/wp-content/uploads/2016/05/result.png" alt="result"></a></p> <p>The next Venn diagram shows how two different techniques are <strong>complementary</strong> at a glance. The figures in parenthesis are the ones except unreachable gadgets. Total coverage with IPR only was about 85% whereas it was about 90% with displacement only. Using both, it goes up to 97%. The unbroken gadgets ends up with 2.6%.</p> <p><a href="http://dandylife.net/blog/archives/606/venn" rel="external nofollow noopener" target="_blank"><img src="http://dandylife.net/blog/wp-content/uploads/2016/05/venn.png" alt="venn"></a></p> <p>For the overhead tests, the industry standard _SPEC2006 _has been used. The performance overhead was around 0.36% on average. Having been some negative overheads, we performed statistical t-test done by establishing the null hypothesis that the means of CPU runtime overhead between original binaries and instrumented ones are the same. The result was that it rejects to fail the null hypothesis. In other words, there is no statically significant difference for negative overheads with 95% confidence interval.</p> <p><strong>VII. Discussion and Limitation</strong></p> <p>First of all, the number of displaceable gadgets still depends on the coverage of disassembly and CFG extraction. In addition, displacement technique requires at least 5 byte space to insert <em>jmp</em> instruction.</p> <p>Next, it cannot defend against <em>ret2libc</em> and <em>JIT-ROP.</em>  However, for return-to-libc, the real attack with actual APIs often requires code reuse for setting up parameters. The latest research shows the idea of JIT-ROP defense by making pages just executable only without readable. Since it constructs the gadgets on the fly after information leak, therefore, displacement technique can be leveraged to prevent JIT-ROP for fine-grained randomization.</p> <p>Lastly, it cannot break the entry-point gadgets, which was less than 1%. </p> <p><strong>VIII. Final words</strong></p> <p>You may find <a href="http://dandylife.net/blog/wp-content/uploads/2016/05/displacement.asiaccs16.pdf" rel="external nofollow noopener" target="_blank">the paper </a> and <a href="http://dandylife.net/blog/wp-content/uploads/2016/05/Juggling-the-Gadgets.pdf" rel="external nofollow noopener" target="_blank">the slide</a> useful in details, which presented in ACM Asia Conference on Computer and Communications Security 2016 (<a href="http://meeting.xidian.edu.cn/conference/AsiaCCS2016/program.html" rel="external nofollow noopener" target="_blank">ASIACCS 2016</a>). The experimental code is now publicly available at <a href="https://github.com/kevinkoo001/ropf" rel="external nofollow noopener" target="_blank">this repository</a> at my Github. </p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2016/code-reuse-attacks-and-defenses/">Code Reuse Attacks and Defenses</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2018/compiler-assisted-code-randomization/">Compiler-assisted Code Randomization</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2016/dynamic-linking-in-elf/">Dynamic Linking in ELF</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2016/cyber-grand-challenge-by-darpa/">Cyber Grand Challenge by DARPA</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2017/elf-sections-for-exception-handling/">ELF Sections for Exception Handling</a> </li> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 Hyungjoon Koo. Last updated: January 30, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>